
from fastmcp import FastMCP
import datetime

# åˆ›å»ºMCPæœåŠ¡å™¨
mcp = FastMCP("SimpleAssistant")

# ä»»åŠ¡å­˜å‚¨
tasks = []

# å·¥å…·1: åˆ›å»ºä»»åŠ¡
@mcp.tool()
def create_task(title: str, description: str = "") -> dict:
    åˆ›å»ºæ–°ä»»åŠ¡
    task = {
        "id": len(tasks) + 1,
        "title": title,
        "description": description,
        "created_at": datetime.datetime.now().isoformat(),
        "completed": False
    }
    tasks.append(task)
    return {"status": "success", "message": f"ä»»åŠ¡ '{title}' å·²åˆ›å»º", "task": task}

å·¥å…·2: è·å–ä»»åŠ¡åˆ—è¡¨
@mcp.tool()
def get_tasks() -> dict:
    """è·å–æ‰€æœ‰ä»»åŠ¡"""
    return {
        "status": "success", 
        "count": len(tasks),
        "tasks": tasks
    }

å·¥å…·3: å®Œæˆä»»åŠ¡
@mcp.tool()
def complete_task(task_id: int) -> dict:
    """æ ‡è®°ä»»åŠ¡ä¸ºå®Œæˆ"""
    if task_id < 1 or task_id > len(tasks):
        return {"status": "error", "message": "ä»»åŠ¡IDæ— æ•ˆ"}
    
    tasks[task_id-1]["completed"] = True
    return {"status": "success", "message": f"ä»»åŠ¡ {task_id} å·²å®Œæˆ"}

å·¥å…·4: è®¡ç®—å™¨
@mcp.tool()
def calculate(expression: str) -> dict:
    """è®¡ç®—æ•°å­¦è¡¨è¾¾å¼"""
    try:
        # å®‰å…¨è®¡ç®—
        result = eval(expression, {"__builtins__": {}})
        return {"status": "success", "result": result}
    except Exception as e:
        return {"status": "error", "message": f"è®¡ç®—é”™è¯¯: {e}"}

å·¥å…·5: è·å–æ—¶é—´
@mcp.tool()
def get_time() -> dict:
    """è·å–å½“å‰æ—¶é—´"""
    now = datetime.datetime.now()
    return {
        "status": "success",
        "time": now.strftime("%Y-%m-%d %H:%M:%S"),
        "timestamp": now.isoformat()
    }

if __name__ == "__main__":
    print("ç®€æ˜“MCPæœåŠ¡å™¨å¯åŠ¨ä¸­...")
    print("å¯ç”¨å·¥å…·:")
    print("  - create_task: åˆ›å»ºä»»åŠ¡")
    print("  - get_tasks: è·å–ä»»åŠ¡åˆ—è¡¨")
    print("  - complete_task: å®Œæˆä»»åŠ¡")
    print("  - calculate: è®¡ç®—å™¨")
    print("  - get_time: è·å–æ—¶é—´")
    mcp.run()


"""
ç®€æ˜“Streamlitç•Œé¢
"""
import streamlit as st
import subprocess
import sys
import json

# é¡µé¢è®¾ç½®
st.set_page_config(page_title="ç®€æ˜“åŠ©æ‰‹", layout="wide")
st.title("ğŸ¤– ç®€æ˜“èŒèƒ½åŠ©æ‰‹")

# å·¥å…·å‡½æ•° - ç›´æ¥è°ƒç”¨æœ¬åœ°å‡½æ•°ï¼ˆç®€æ˜“æ–¹å¼ï¼‰
tasks = []

def create_task_local(title, description=""):
    """æœ¬åœ°åˆ›å»ºä»»åŠ¡"""
    task = {
        "id": len(tasks) + 1,
        "title": title,
        "description": description,
        "completed": False
    }
    tasks.append(task)
    return task

def get_tasks_local():
    """æœ¬åœ°è·å–ä»»åŠ¡"""
    return tasks

def complete_task_local(task_id):
    """æœ¬åœ°å®Œæˆä»»åŠ¡"""
    if 0 < task_id <= len(tasks):
        tasks[task_id-1]["completed"] = True
        return True
    return False

# æ ‡ç­¾é¡µ
tab1, tab2, tab3 = st.tabs(["ğŸ“ ä»»åŠ¡ç®¡ç†", "ğŸ§® è®¡ç®—å™¨", "âš™ï¸ æœåŠ¡å™¨æ§åˆ¶"])

# æ ‡ç­¾é¡µ1: ä»»åŠ¡ç®¡ç†
with tab1:
    st.header("ä»»åŠ¡ç®¡ç†")
    
    # åˆ›å»ºæ–°ä»»åŠ¡
    with st.form("åˆ›å»ºä»»åŠ¡è¡¨å•"):
        title = st.text_input("ä»»åŠ¡æ ‡é¢˜", placeholder="è¾“å…¥ä»»åŠ¡æ ‡é¢˜")
        description = st.text_area("ä»»åŠ¡æè¿°", placeholder="è¾“å…¥ä»»åŠ¡æè¿°")
        if st.form_submit_button("åˆ›å»ºä»»åŠ¡"):
            if title:
                task = create_task_local(title, description)
                st.success(f"ä»»åŠ¡ '{title}' åˆ›å»ºæˆåŠŸï¼")
                st.rerun()
            else:
                st.warning("è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜")
    
    # æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨
    st.subheader("ä»»åŠ¡åˆ—è¡¨")
    if not tasks:
        st.info("æš‚æ— ä»»åŠ¡")
    else:
        for task in tasks:
            status = "âœ…" if task["completed"] else "â³"
            st.write(f"{status} **{task['title']}**")
            if task["description"]:
                st.caption(task["description"])
            
            col1, col2 = st.columns([6, 1])
            with col2:
                if not task["completed"]:
                    if st.button("å®Œæˆ", key=f"complete_{task['id']}"):
                        complete_task_local(task['id'])
                        st.rerun()

# æ ‡ç­¾é¡µ2: è®¡ç®—å™¨
with tab2:
    st.header("è®¡ç®—å™¨")
    
    expression = st.text_input("è¾“å…¥è¡¨è¾¾å¼", placeholder="ä¾‹å¦‚ï¼š2 + 3 * 4")
    if st.button("è®¡ç®—"):
        if expression:
            try:
                # å®‰å…¨è®¡ç®—
                result = eval(expression, {"__builtins__": {}})
                st.success(f"ç»“æœ: **{result}**")
            except Exception as e:
                st.error(f"è®¡ç®—é”™è¯¯: {e}")
        else:
            st.warning("è¯·è¾“å…¥è¡¨è¾¾å¼")

# æ ‡ç­¾é¡µ3: æœåŠ¡å™¨æ§åˆ¶
with tab3:
    st.header("MCPæœåŠ¡å™¨æ§åˆ¶")
    
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("å¯åŠ¨MCPæœåŠ¡å™¨"):
            try:
                # å¯åŠ¨MCPæœåŠ¡å™¨ï¼ˆåå°ï¼‰
                process = subprocess.Popen(
                    [sys.executable, "mcp_server_main.py"],
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    text=True
                )
                st.session_state.mcp_process = process
                st.success("MCPæœåŠ¡å™¨å·²å¯åŠ¨")
            except Exception as e:
                st.error(f"å¯åŠ¨å¤±è´¥: {e}")
    
    with col2:
        if st.button("åœæ­¢MCPæœåŠ¡å™¨", disabled="mcp_process" not in st.session_state):
            if "mcp_process" in st.session_state:
                st.session_state.mcp_process.terminate()
                del st.session_state.mcp_process
                st.success("MCPæœåŠ¡å™¨å·²åœæ­¢")
    
    # æ˜¾ç¤ºæœåŠ¡å™¨ä¿¡æ¯
    st.subheader("æœåŠ¡å™¨çŠ¶æ€")
    st.info("MCPæœåŠ¡å™¨æä¾›äº†5ä¸ªå·¥å…·ï¼šåˆ›å»ºä»»åŠ¡ã€è·å–ä»»åŠ¡ã€å®Œæˆä»»åŠ¡ã€è®¡ç®—å™¨ã€è·å–æ—¶é—´")

# ä¾§è¾¹æ 
with st.sidebar:
    st.header("ğŸ“Š ç»Ÿè®¡")
    st.metric("ä»»åŠ¡æ€»æ•°", len(tasks))
    st.metric("æœªå®Œæˆ", len([t for t in tasks if not t["completed"]]))
    
    st.divider()
    
    st.header("âš¡ å¿«æ·æ“ä½œ")
    if st.button("æ¸…ç©ºå·²å®Œæˆä»»åŠ¡"):
        global tasks
        tasks = [t for t in tasks if not t["completed"]]
        st.rerun()

# é¡µè„š
st.divider()
st.caption("ç®€æ˜“èŒèƒ½åŠ©æ‰‹ v1.0 | ä½¿ç”¨ Streamlit + FastMCP æ„å»º")
